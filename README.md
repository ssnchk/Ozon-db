

# Проектирование баз данных

# Предметная область: OZON (маркетплейс)
### Общее описание

Проект представляет собой полноценную систему хранения и обработки данных, реализованную на основе выбранной предметной области. Он включает в себя спроектированную схему базы данных, автоматизированное развертывание инфраструктуры, наполнение тестовыми данными, управление доступом, мониторинг состояния системы, оптимизацию производительности, резервное копирование и обеспечение отказоустойчивости.

---

### Архитектура и модель данных

Создана нормализованная схема базы данных, соответствующая **третьей нормальной форме (3НФ)**, с возможностью указания участков намеренной денормализации. Схема включает не менее **20 таблиц**, описывающих все аспекты предметной области. Для наглядного представления структуры данных построена **ER-диаграмма** с использованием инструмента **PlantUML**.

---

### Инфраструктура и автоматизация

СУБД **PostgreSQL** развернута в **Docker-контейнере** с помощью `docker-compose`. Реализована автоматическая загрузка SQL-скриптов миграций, которые применяются при старте контейнера. Миграции являются **идемпотентными**, поддерживают версионность и позволяют применять схему до указанной версии (`MIGRATION_VERSION`). Все операции выполняются от имени пользователя с минимальными необходимыми привилегиями.

---

### Наполнение данными

При запуске в режиме разработки (`APP_ENV=dev`) автоматически запускается процесс **семирования (seeding)** базы данных. Тестовые данные генерируются с использованием библиотеки `faker` и имитируют реальные данные. Количество записей регулируется переменной окружения `SEED_COUNT`.

---

### Управление доступом

Реализована система ролей и пользователей:
- Создана групповая роль `analytic` с правами только на чтение.
- На её основе создаются пользователи, имена которых передаются через переменную `ANALYST_NAMES`.
- Пароли формируются по шаблону: `имя_123`.

---

### Мониторинг и визуализация

Для мониторинга состояния базы данных подключены:
- **Prometheus** — сбор метрик,
- **Grafana** — визуализация метрик.

Настроен дашборд в Grafana, сохранён в виде JSON-файла. Метрики включают в себя параметры нагрузки, количество активных соединений, время выполнения запросов и другие ключевые показатели.

---

### Оптимизация производительности

Разработан сервис, имитирующий типичные запросы к БД, характерные для предметной области

Выполняется замер времени выполнения запросов, который визуализируется в Grafana. Далее проводится оптимизация:
- добавление индексов,
- партиционирование таблиц,
- использование материализованных представлений,
- денормализация при необходимости.

Результаты сравнения производительности до и после оптимизации сохраняются и отображаются на графиках.

---

### Резервное копирование

Настроен механизм автоматического резервного копирования базы данных:
- периодичность задается через `BACKUP_INTERVAL_CRON`,
- количество хранимых бэкапов ограничено переменной `BACKUP_RETENTION_COUNT`.

---

### Отказоустойчивость

Для обеспечения высокой доступности реализована кластерная архитектура PostgreSQL с использованием **Patroni**. В кластере используются:
- один мастер-сервер,
- две реплики.

Обеспечивается автоматическое переключение на одну из реплик в случае недоступности мастера.

---

# Функциональные требования предметной области

1. **Регистрация и авторизация пользователей:**

    - Система должна предоставлять возможность регистрации новых пользователей (покупателей и продавцов) через email или
      номер телефона.

    - Система должна обеспечивать авторизацию зарегистрированных пользователей.

    - Система должна поддерживать восстановление пароля в случае его утери.

2. **Управление профилем пользователя:**

    - Покупатели должны иметь возможность редактировать свои личные данные (имя, адрес, телефон, email).

    - Продавцы должны иметь возможность добавлять и редактировать информацию о своем магазине (название, описание,
      контакты).

3. **Поиск и фильтрация товаров:**

    - Система должна предоставлять возможность поиска товаров по ключевым словам, категория, подкатегориям какой-либо
      категории, брендам и другим параметрам.

    - Пользователи должны иметь возможность фильтровать товары по цене, рейтингу, наличию, доставке и другим критериям.

    - Должны существовать категории и подкатегории, которые должны наследоваться от какой-либо категории

4. **Просмотр карточки товара:**

    - Для каждого товара должна быть доступна детальная информация: название, описание, цена, скидка, отзывы, рейтинг,
      наличие на складе.

    - Пользователи должны иметь возможность оставлять отзывы и оценки для товаров.

    - Пользователи могут задавать вопросы по товарам. Эти вопросы и ответы на них могут просматривать другие
      пользователи в карточке товаров.

5. **Управление корзиной и оформление заказа:**

    - Пользователи должны иметь возможность добавлять товары в корзину, изменять количество товаров и удалять их из
      корзины.

    - Система должна предоставлять возможность оформления заказа с выбором способа оплаты и доставки.

    - Среди выборов способов оплаты должны быть карты/наличные

    - Среди выборов способов доставки должны быть ПВЗ/доставка курьером
   
    - Пользователи должны иметь возможность отслеживать статус заказа.

    - Кроме корзины пользователь может лайкнуть товар

    - Пользователь имеет возможность вернуть товар
6. **Оплата товаров:**

    - Система должна поддерживать различные способы оплаты: банковские карты, электронные кошельки, оплата при
      получении.

7. **Доставка товаров:**

    - Система должна предоставлять выбор способов доставки: курьерская доставка, самовывоз в пункт выдачи заказов.

    - Пользователи должны иметь возможность отслеживать статус доставки.

8. **Управление заказами для продавцов:**

    - Продавцы должны иметь возможность добавлять, редактировать и удалять товары в своем магазине.

    - Продавцы должны видеть список заказов, их статусы и контактные данные покупателей.

9. **Система уведомлений:**

    - Пользователи должны получать уведомления о статусе заказа, акциях и новых поступлениях через email, SMS или
      push-уведомления.

10. **Администрирование системы:**

    - Администратор должен иметь возможность управлять пользователями, продавцами, товарами, заказами и настройками
      системы.

    - Администратор должен иметь возможность забанить продавца/пользователя

    - Администратор должен иметь доступ к аналитике: продажи, популярные товары, активность пользователей

11. **Система учета и хранения данных о заказе**

    - Для ПВЗ должны вестись часы работы, учет расходов и доходов

    - Должен вестись учет рабочих в ПВЗ и доставщиков 

    - Для доставщиков следует хранить их расписание, их заказы с указанными маршрутами доставки

12. **Система скидок и акций:**

    - Система должна поддерживать создание скидок, акций и промокодов для товаров.

    - Пользователи должны иметь возможность применять промокоды, действующие на все товары (на всю корзину).

13. **Рекомендации и персонализация:**

    - Система должна предлагать персонализированные рекомендации товаров на основе истории покупок и просмотров
      пользователя.

# ERD

![Описание изображения](erd.png)